# Develop Logseq
## Requirements

- [Node.js](https://nodejs.org/en/download/) (See [build.yml](https://github.com/logseq/logseq/blob/master/.github/workflows/build.yml) for allowed version)  & [Yarn](https://classic.yarnpkg.com/en/docs/install/)
- [Java & Clojure](https://clojure.org/guides/getting_started). (If you run into `Execution error (FileNotFoundException) at java.io.FileInputStream/open0 (FileInputStream.java:-2). -M:cljs (No such file or directory)`, it means you have a wrong Clojure version installed. Please uninstall it and follow the instructions linked.)

## Clone project

This is a required step before doing any development or production builds.

```bash
git clone https://github.com/logseq/logseq
cd logseq
```

## Browser development

### Development

```bash
yarn
yarn watch
```

Then open the browser <http://localhost:3001>.

### REPL setup

#### VSCode + Calva
With ```yarn watch``` running, it should prints ``shadow-cljs - nREPL server started on port 8701``

You may connect to the nREPL server with:

``cmd + shift + p`` -> ``Calva: Connect to a Running REPL Server in the Project`` -> ``logseq`` -> ``shadow-cljs``->``:app`` ->``localhost:8701``

(change ``:app`` to ``:electron`` if you want to connect to the main thread of the Electron app)

Open a dev environment (Browser dev app on ``localhost:3000`` or Desktop dev app), then you can play REPL on the current editing file:

``cmd + shift + p`` -> ``Calva: Load/Evaluate Current File and its Requires/Dependencies``

### Production Build

```bash
yarn release
```

The released files will be at `static/` directory.

## Desktop app development

### Development

1. Install npm packages for building the desktop app

``` bash
yarn install
cd static
yarn install
cd ..
```

2. Compile to JavaScript and open the dev app

```bash
yarn watch
# Wait until watch reports `Build Completed.` for `:electron` and `:app`.
# Then, run the following command in a different shell.
# If you have opened desktop logseq, you should close it. Otherwise, this command will fail.

# If you are using a Python version newer than 3.10, you may experience this error.
# """node-gyp failed to rebuild.
# For more information, rerun with the DEBUG environment variable set to "electron-rebuild".
# Error: `gyp` failed with exit code: 1"""
# So, you have to downgrade Python to a version lower than 3.10, or you can set up a Python virtual environment with python version 3.10,
# because node-gyp@9.0.0 requires Python <= 3.10. To set up Python, you can follow the instructions below.

# if you had setup the python environment run this command first
# $ source logseq-py-env/bin/activate          


# Attention if you run into this error and you are running ubuntu
# """The SUID sandbox helper binary was found, but is not configured correctly. Rather than run without sandboxing I'm aborting now.""
# https://github.com/electron/electron/issues/42510#issuecomment-2171583086
# The solution is to lift the restrictions that Ubuntu 24.04 implements in the AppImages.
# $ sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
# for deactivate restrictions
yarn dev-electron-app
```

Alternatively, run `bb dev:electron-start` to do this step with one command. To
download bb, see https://github.com/babashka/babashka#installation.

3. (Optional) Update dependencies if `resources/package.json` has changed since
the last time you used dev Logseq.

```bash
# pull new changes
git pull

cd static && yarn install && cd ..
```

Here `static/` is generated by `yarn watch` command.

##### installing python3.10
Step 1 – Install Required Packages

Use the following command to install prerequisites for Python before installing it.

```bash
sudo apt-get install build-essential checkinstall
sudo apt-get install libreadline-gplv2-dev libncursesw5-dev libssl-dev libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev
```

Step 2 – Download Python 3.10.16

Download Python using following command from python official site. You can also download latest version in place of specified below.

```bash
cd /usr/src
sudo wget https://www.python.org/ftp/python/3.10.16/Python-3.10.16.tar.xz
```
Now extract the downloaded package.

```bash
sudo tar xzf Python-3.10.16.tgz
```
Step 3 – Compile Python Source

Use below set of commands to compile python source code on your system using altinstall.

```bash
cd Python-3.10.16
sudo ./configure
sudo make altinstall
```

**make altinstall is used to prevent replacing the default python binary file /usr/bin/python.**
Step 4 – Check the Python Version

Check the latest version installed of python using below command.

```bash
$ python3.10 -V

Python 3.10.16
```
Step 5 - Setting a python environment

```bash
sudo apt install python3-virtualenv
virtualenv logseq-py-env -p `which python3.10`
```

### Production Build

Build a release:

```bash
yarn release-electron
```

The final released binaries or installers will be at `static/out/`.
