# Develop Logseq

- [Requirements](#requirements)
- [Clone project](#clone-project)
- [Browser development](#browser-development)
  - [Development](#development)
  - [Development using Docker](#development-using-docker)
    - [Requrments for development using Docker](#requrments-for-development-using-docker)
    - [Runing docker-compose for development](#runing-docker-compose-for-development)
  - [REPL setup](#repl-setup)
    - [VSCode + Calva](#vscode--calva)
  - [Production Build](#production-build)
- [Desktop app development](#desktop-app-development)
  - [Development](#development-1)
  - [Production Build](#production-build-1)

## Requirements

- [Node.js](https://nodejs.org/en/download/) (See [build.yml](https://github.com/logseq/logseq/blob/master/.github/workflows/build.yml) for allowed version)  & [Yarn](https://classic.yarnpkg.com/en/docs/install/)
- [Java & Clojure](https://clojure.org/guides/getting_started). (If you run into `Execution error (FileNotFoundException) at java.io.FileInputStream/open0 (FileInputStream.java:-2). -M:cljs (No such file or directory)`, it means you have a wrong Clojure version installed. Please uninstall it and follow the instructions linked.)

## Clone project

This is a required step before doing any development or production builds.

```bash
git clone https://github.com/logseq/logseq
cd logseq
```

## Browser development

### Development

```bash
yarn
yarn watch
```

Then open the browser <http://localhost:3001>.

### Development using Docker

No need to install [dependencies](#requirements) locally.\
Docker will handle all requirments for you.

#### Requrments for development using Docker

Make sure [docker](https://docs.docker.com/engine/install/) and [docker-compose](https://docs.docker.com/compose/install/) installed.

#### Runing docker-compose for development

To build base image `Dockerfile.dev` will be used.\
Start docker-compose with command:

```bash
docker-compose -f docker-compose.dev.yml up -d && docker-compose -f docker-compose.dev.yml logs -f
```

You will see logs of application, you free to use `Ctrl+c` to exit from application logs, application itself will continue running.\
You can open applicaiton using <http://localhost:3001>

To stop application use

```bash
docker-compose -f docker-compose.dev.yml down
```

### REPL setup

#### VSCode + Calva

With ```yarn watch``` running, it should prints ``shadow-cljs - nREPL server started on port 8701``

You may connect to the nREPL server with:

``cmd + shift + p`` -> ``Calva: Connect to a Running REPL Server in the Project`` -> ``logseq`` -> ``shadow-cljs``->``:app`` ->``localhost:8701``

(change ``:app`` to ``:electron`` if you want to connect to the main thread of the Electron app)

Open a dev environment (Browser dev app on ``localhost:3000`` or Desktop dev app), then you can play REPL on the current editing file:

``cmd + shift + p`` -> ``Calva: Load/Evaluate Current File and its Requires/Dependencies``

### Production Build

```bash
yarn release
```

The released files will be at `static/` directory.

## Desktop app development

### Development

1. Install npm packages for building the desktop app

``` bash
yarn install
```

2. Compile to JavaScript and open the dev app

```bash
yarn watch
# Wait until watch reports `Build Completed.` for `:electron` and `:app`.
# Then, run the following command in a different shell.
# If you have opened desktop logseq, you should close it. Otherwise, this command will fail.
yarn dev-electron-app
```

Alternatively, run `bb dev:electron-start` to do this step with one command. To
download bb, see https://github.com/babashka/babashka#installation.

3. (Optional) Update dependencies if `resources/package.json` has changed since
the last time you used dev Logseq.

```bash
# pull new changes
git pull

cd static && yarn install && cd ..
```

Here `static/` is generated by `yarn watch` command.

### Production Build

Build a release:

```bash
yarn release-electron
```

The final released binaries or installers will be at `static/out/`.
